<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>PIC32CX-BZ Zigbee API Reference: Programming basics</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PIC32CX-BZ Zigbee API Reference</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">Programming basics </div>  </div>
</div>
<div class="contents">
<div class="textblock"><p>This API Reference manual is intended do provide detailed information about all public Microchip Zigbee APIs, generally describe the stack components and how to perform typical tasks, providing multiple sample code examples. This document is mostly the source of reference information and code examples, while <em>AVR2050: Microchip Zigbee Developer Guide</em> available in the SDK as a PDF document contains conceptual description of Microchip Zigbee stack's functionality.</p>
 
<span class="table_of_contents">Contents</span>
<ul class="table_of_contents">
  <li><a href="#api_doc_structure">API documentation structure</a></li>
  <li><a href="#task_handlers">Task handlers</a></li>
  <li><a href="#main_func">The <code>main()</code> function</a></li>
  <li><a href="#layers_communication">Communication between layers</a></li>
  <li><a href="#req_conf">Requests and confirmations</a></li>
  <li><a href="#def_task_exec">Deferring task execution</a></li>
</ul>
<p></p>
<h2><a class="anchor" id="api_doc_structure"></a>
API documentation structure</h2>
<p>Each main stack component has the corresponding page, which may be accessed from the root of the left navigation tree. Such page focuses on some typical tasks that may be done with the help of the component's API. The page's <em>References</em> section provides links to pages that collect component's API functions and their descriptions and may also include other related references.</p>
<p>A separate chapter describes sample applications provided with the SDK.</p>
<p>The <em>References</em> chapter comprises lists of functions, structures, header files etc. The <em>Modules</em> subchapter</p>
<h2><a class="anchor" id="task_handlers"></a>
Task handlers</h2>
<p>The Microchip Zigbee stack and user's applications built on top of Microchip Zigbee operate in a single-threaded environment. Allocation of the execution time is controlled by the task scheduler, which is an internal mechanism implemented by the stack. The task scheduler manages the order in which tasks raised by different stack components are executed. The order is based on the priority of layers. The user's application has the lowest priority. Tasks posted by a certain layer are processed with a call to the corresponding task handler which is a function specific for each layer. The application task handler is called <a class="el" href="sys_task_manager_8h.html#aec14264f3afa11a970347e765c44d9ef">APL_TaskHandler()</a> and should be implemented by the application.</p>
<h2><a class="anchor" id="main_func"></a>
The main() function</h2>
<p>The starting point of a Microchip Zigbee application is the <code>main()</code> function. In older Microchip Zigbee versions it was implemented by the stack and its source code was unavailable for the application developers. At this moment the <code>main()</code> function body is defined by the user's application to make the application development more flexible.</p>
<p>The <code>main()</code> function must contain two mandatory elements: a call to the <a class="el" href="group__sys.html#ga754f4af3ac3b77f2e4b58e0ade073275" title="Initializes the microconroller and the radio chip.">SYS_SysInit()</a> function and the infinite loop with <a class="el" href="group__sys.html#ga445f4a39e0b3cb95bf80ed93867b0ebc" title="This function is called by the stack or from the main() function to process tasks.">SYS_RunTask()</a> inside, which allows the task scheduler to call the next appropriate task handler.</p>
<p>A typical <code>main()</code> function implementation is shown below:</p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>)
{
  <a class="code" href="group__sys.html#ga754f4af3ac3b77f2e4b58e0ade073275" title="Initializes the microconroller and the radio chip.">SYS_SysInit</a>();
  
  <span class="keywordflow">for</span> (;;) {
    <a class="code" href="group__sys.html#ga445f4a39e0b3cb95bf80ed93867b0ebc" title="This function is called by the stack or from the main() function to process tasks.">SYS_RunTask</a>();
  }
}
</pre></div><h2><a class="anchor" id="layers_communication"></a>
Communication between layers</h2>
<p>The user's application may be considered an additional layer to those present in the stack and Microchip Zigbee functions as requests sent from the application to the underlying layers.</p>
<p>Communication between different layers including requests between different stack layers is based on the event-driven programming model. A few operations, which do not consume much execution time, are synchronous such as those that involve reading from and writing to internal stack structres. But tasks implying sending requests to other nodes in the network are always executed asynchronously as they result in considerably longer waiting for response. In order not to lock the execution flow (which is single-threaded on an MCU) such requests provide pointers to callbacks which are called at the end of request execution by the underlying layer, to which the request is issued.</p>
<h2><a class="anchor" id="req_conf"></a>
Requests and confirmations</h2>
<p>A function that performs an asynchronous request to a Microchip Zigbee component always has a name ended with <em>Req</em>. The function argument in this case is a pointer to a structure which name is obtained from the function's name by adding <em>_t</em>, a mark denoting a type. This structure is regarded to in documentation as request parameters. The main field it includes is a pointer to a callback function which is called to confirm request execution. In addition to the callback function, request parameters include confirmation parameters' structure as a field. The latter structure's name is obtained by replacing <em>Req</em> in its name to <em>Conf</em>. For example, network start request is issued by the <a class="el" href="group__zdo.html#ga5c2330058e9c40c5c771964b0f606c58" title="Performs network formation for coordinator and network join for router or end device.">ZDO_StartNetworkReq(ZDO_StartNetworkReq_t *req)</a> function, where <a class="el" href="struct_z_d_o___start_network_req__t.html" title="Describes the parameters of the ZDO_StartNetworkReq() function.">ZDO_StartNetworkReq_t</a> has the <code>confirm</code> field of the <a class="el" href="struct_z_d_o___start_network_conf__t.html" title="Describes the parameters of the ZDO_StartNetworkConf() function.">ZDO_StartNetworkConf_t</a> type.</p>
<p>An instance of request parameters must be declared as a global variable, because the confirmation callback's argument points exactly to the confirmation parameters' field inside the request parameters. This requires that the instance of request parameres exists after the invoking function loses control. Moreover, the user should ensure that the instance will not be reused while current request is being executed.</p>
<p>The <code>status</code> field of the confirmation parameters indicates whether the request is executed successfully and reports the failure reason if it is not a success. The status is given by the value of the enumeration type defined for each stack component (for example, <a class="el" href="aps_common_8h.html#a1b4ff3a412400f1920d4d56e771230c8" title="APS status values.">APS_Status_t</a>). However, the value of the status field may not fall in the range defined by the enumeration because a failure during request execution may occur not only on the layer to which the request is sent directly, but on the lower layers also.</p>
<h2><a class="anchor" id="def_task_exec"></a>
Deferring task execution</h2>
<p>Microchip Zigbee applications must to conform to certain restrictions for execution times of functions defined by the applications:</p>
<ul>
<li>The application task handler <a class="el" href="sys_task_manager_8h.html#aec14264f3afa11a970347e765c44d9ef">APL_TaskHandler()</a> function must execute in less than 50ms.</li>
</ul>
<ul>
<li>A callback defined by the application must execute in less than 10ms.</li>
</ul>
<p>If a certain callback has to perform some time-consuming actions and would not finish in 10ms, the application may defer the callback exection and transfer its logic to the task handler by posting a task for <a class="el" href="sys_task_manager_8h.html#aec14264f3afa11a970347e765c44d9ef">APL_TaskHandler()</a> via the <a class="el" href="group__sys.html#ga19cb63c28d94c2870db54ef53ba2ccd3" title="Posts a task to the task manager, which is later processed by the task handler of the corresponding s...">SYS_PostTask()</a> using <code>APL_TASK_ID</code> as an argument. </p>
</div></div>
<hr style="border-top:1px solid #C4CFE5; margin-top:20px"/>
</body>
</html>
