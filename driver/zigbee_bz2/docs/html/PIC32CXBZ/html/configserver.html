<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>PIC32CX-BZ Zigbee API Reference: Configuration Server</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PIC32CX-BZ Zigbee API Reference</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">Configuration Server </div>  </div>
</div>
<div class="contents">
<div class="textblock"><p>The BitCloud stack provides an extensive set of configuration parameters which determine different aspects of network and node behavior. These parameters are accessible for an application via the Configuration Server interface (ConfigServer or CS for short).</p>
<p>CS parameters can be divided in a set of categories according to different criteria. For example, one can distinhuish persistent and non persistent parameters. Persistent parameters are stored in power independent EEPROM memory and their values stay unchanged after the node HW reset. Non persistent parameters are stored in RAM memory and upon HW reset are reinitialized with their default values. Whether a certain CS parameter belongs to a category is highlighted in the corresponding entry on the <a href="cs_defaults_8h.html" class="el">CS parameters defaults</a> page. Other criteria mark out parameters that can be set only at compilation time, such as the parameters that are used to calculate an amount of memory to be allocated by the application, and the parameters that can be changed only when the device is out of network since they determine certain network related aspects of node behavior.</p>
<p>Note that if a parameter is persistent, this automatically means that it can be modified at run time, because there is no need to store in EEPROM parameters that can not be changed between two HW resets.</p>
<p>The sections below describe typical cases of CS parameters usage accompanied with exaplanations on how they affects the application's or node's behavior.</p>
<p><span class="table_of_contents">References</span> </p>
<ul>
<li><a class="el" href="group__cs__functions.html">CS functions</a> </li>
<li><a href="cs_defaults_8h.html" class="el">CS parameters defaults</a></li>
</ul>
 
<hr style="border-top:1px solid #E0E0FF; margin-top:10px"/>

<span class="table_of_contents">Contents</span>
<ul class="table_of_contents">
  <li><a href="#get_set_param">How to get or set a CS parameter</a></li>
  <li>
    <a href="#cs_nwk_start">Using parameters influencing network start</a>
    <ul>
      <li><a href="#cs_device_type">Choosing device type</a></li>
      <li><a href="#cs_nwk_panid">Handling the network PANID</a></li>
      <li><a href="#cs_stoch_static_addr">Stochastic and static addressing</a></li>
    </ul>
  </li>
  <li><a href="#cs_sleep_time">Sleeping end device's time spans</a></li>
  <li><a href="#cs_fragment">Configuring fragmentation</a></li>
  <li><a href="#cs_tables">Understanding table sizes</a></li>
  <li><a href="#cs_sec_keys">Security keys</a></li>
</ul>
<p></p>
 <span class="to_top"><a href="#">Back to top</a></span>  <h2><a class="anchor" id="get_set_param"></a>
How to get or set a CS parameter</h2>
<p>There are two options to assign a value to the CS parameter. One is to specify the value at compilation time by adding a line or changing an existing one in the <code>configuration.h</code> file. A line shall be an ordinary <code>#define</code> preprocessor directive, for example, to set the maximum number of childs that the node, provided it is a router or the coordinator, can accept to 5 put the following line in <code>configuration.h</code>:</p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#define CS_MAX_CHILDREN_AMOUNT 5</span>
</pre></div><p>Fortunately, most of the parameters have default values that fit typical application configuration well, at least for the first time. The default values are given in <a href="cs_defaults_8h.html" class="el"><code>csDefaults.h </code></a> which is a part of BitCloud. This file must not be changed. If the application needs to modify a default value it shall perform this in the application <code>configuration.h</code> file.</p>
<p>To change values of the parameters that can be configured at run time use the <a class="el" href="group__cs__functions.html#ga0ea8ddc7bc41ce1c5ba556058ee1073b" title="Gets the value of the parameter specified by its ID and writes it to the provided address in memory...">CS_ReadParameter()</a> function. For both compile-time and run-time configured parameters the application can read their value via the <a class="el" href="group__cs__functions.html#ga3106f18b9723751a9a5fa9deefa9d906" title="Sets a value of a certain Configuration Server parameter specified by its ID.">CS_WriteParameter()</a> function. To find out the detailed desciption proceed to the documentation of these function.</p>
 <span class="to_top"><a href="#">Back to top</a></span>  <h2><a class="anchor" id="cs_nwk_start"></a>
Using parameters influencing network start</h2>
<p>Certain CS parameters are used to achieve an appropriate form of network start. This helps choose a proper network by predefining the network PANID or set either static or stochastic addressing scheme, etc.</p>
<h3><a class="anchor" id="cs_device_type"></a>
Choosing device type</h3>
<p>In addition to the <a class="el" href="cs_defaults_8h.html#a02e2ff3a28ff0075a45faa96f720fd56" title="Default value for the type of a device.">CS_DEVICE_TYPE</a> parameter which specifies the type of a device according to ZigBee specification, another parameter, called <a class="el" href="cs_defaults_8h.html#ade47a6e7283158d637e8a4fd5c3c6a80" title="Specifies receiver state (enabled or disabled) during inactive period for an end device.">CS_RX_ON_WHEN_IDLE</a> should be taken into consideration to determine the device type. <a class="el" href="cs_defaults_8h.html#ade47a6e7283158d637e8a4fd5c3c6a80" title="Specifies receiver state (enabled or disabled) during inactive period for an end device.">CS_RX_ON_WHEN_IDLE</a> indicates whether the radio is turned on permanently. Therefore on routers and the coordinator its value must always be <code>true</code>. If parameter's value is <code>false</code> which must happen on end devices only, the radio is turned on to transmit data only and to wait for response from a parent for a certain short period of time. Besides, being set to false the parameter enables polling mechanism allowing sleeping end devices to receive deferred messages stored by its parent while the end device slept. For that reason, on sleeping end devices <a class="el" href="cs_defaults_8h.html#ade47a6e7283158d637e8a4fd5c3c6a80" title="Specifies receiver state (enabled or disabled) during inactive period for an end device.">CS_RX_ON_WHEN_IDLE</a> shall be set to <code>false</code>.</p>
<p>For example, suppose that the device type is to be specified at run-time, then a typical way to configure a sleeping end device is as follows:</p>
<div class="fragment"><pre class="fragment"><span class="comment">//Prepare variables</span>
<a class="code" href="app_framework_8h.html#aef965477e435259ad93f316e8cc286ca">DeviceType_t</a> deviceType = DEVICE_TYPE_END_DEVICE;
<span class="keywordtype">bool</span> rxOnWhenIdle = <span class="keyword">false</span>;

<span class="comment">//Set parameters</span>
<a class="code" href="group__cs__functions.html#ga3106f18b9723751a9a5fa9deefa9d906" title="Sets a value of a certain Configuration Server parameter specified by its ID.">CS_WriteParameter</a>(CS_DEVICE_TYPE_ID,&amp;deviceType);
<a class="code" href="group__cs__functions.html#ga3106f18b9723751a9a5fa9deefa9d906" title="Sets a value of a certain Configuration Server parameter specified by its ID.">CS_WriteParameter</a>(CS_RX_ON_WHEN_IDLE_ID, &amp;rxOnWhenIdle);
</pre></div><h3><a class="anchor" id="cs_nwk_panid"></a>
Handling the network PANID</h3>
<p>There are two identifier for the network: extended PANID and short (also called network) PANID. The first taking 64-bit values is the main idetifier, while a 16-bit value for the second in most cases is generated randomely and is used in frame headers instead of the extended PANID to reduce overhead. The extended PANID is predefined with the <a class="el" href="cs_defaults_8h.html#ad913e01b52dd44a469260af694c6fd84" title="Extended PAN ID of the network to which the device should join.">CS_EXT_PANID</a> parameter causing the coordinator to form a network with the PANID equal to this paramater and other nodes to join the network with the PANID equal to this paramater. If a router or an end device specifies <code>0x0</code> for <a class="el" href="cs_defaults_8h.html#ad913e01b52dd44a469260af694c6fd84" title="Extended PAN ID of the network to which the device should join.">CS_EXT_PANID</a>, then it will join the first suitable network.</p>
<p>The short PANID can also be predefined on the coordinator, for example, when it has to be reset and restore connection to the same network after is powers on. In this case <a class="el" href="cs_defaults_8h.html#a5d5e2761565becd39271d0169b239056" title="Indication to use a predefined network PANID value.">CS_NWK_PREDEFINED_PANID</a> shall be set to <code>1</code>. The parameters can be configured either in compile or run time. The following example shows the latter case:</p>
<div class="fragment"><pre class="fragment"><span class="comment">//Prepare variables</span>
<span class="keywordtype">bool</span> predefPANID = <span class="keyword">true</span>;
uint16_t nwkPANID = CPU_TO_LE16(0x1111); <span class="comment">//Set to 16-bit value converted to little endian format</span>

<a class="code" href="group__cs__functions.html#ga3106f18b9723751a9a5fa9deefa9d906" title="Sets a value of a certain Configuration Server parameter specified by its ID.">CS_WriteParameter</a>(CS_NWK_PREDEFINED_PANID_ID,&amp;predefPANID); <span class="comment">//Indicate that the PANID is predefined</span>
<a class="code" href="group__cs__functions.html#ga3106f18b9723751a9a5fa9deefa9d906" title="Sets a value of a certain Configuration Server parameter specified by its ID.">CS_WriteParameter</a>(CS_NWK_PANID_ID, &amp;nwkPANID); <span class="comment">//Set the PANID value</span>
</pre></div><h3><a class="anchor" id="cs_stoch_static_addr"></a>
Stochastic and static addressing</h3>
<p>The user can choose between stochastic and static addressing schemes to address nodes in the network by setting the <a class="el" href="cs_defaults_8h.html#a61ca65434a24b29c36a157f1e7fbf848" title="Determines whether the static or automatic addressing mode will be used for the short address...">CS_NWK_UNIQUE_ADDR</a> parameter to <code>0</code> or <code>1</code>, respectively. Addressing scheme determines the method used for assigning a short (network) address for the device in the following way: in stochastic scheme a short address is chosen by the stack automatically during network start different from all existing addresses in the network, while in static addressing the value provided by the <a class="el" href="cs_defaults_8h.html#a2df225a416b19f639fb9b3bcf1ca8d8a" title="Device&#39;s short address if CS_NWK_UNIQUE_ADDR equals 1.">CS_NWK_ADDR</a> parameter is used. In the latter case it is up to the user to ensure that all addresses assigned to nodes in the network are unique.</p>
 <span class="to_top"><a href="#">Back to top</a></span>  <h2><a class="anchor" id="cs_sleep_time"></a>
Sleeping end device's time spans</h2>
<p>For correct communications between routers and sleeping end devices special attention should be given to a set of CS parameters. The <a class="el" href="cs_defaults_8h.html#af9a5ae0ebfa0d1b3edb25e8acb8738fc" title="End device sleep period given in milliseconds.">CS_END_DEVICE_SLEEP_PERIOD</a> parameter serves exactly as it is named, that is, on an end device it specifies the length of a time span for which the end device falls asleep when the <a class="el" href="group__zdo.html#gac14909eed15722fb312708ef60c51f41" title="Puts the device into the sleep mode.">ZDO_SleepReq()</a> request is executed and confirmed. The end of a sleep period is indicated by <a class="el" href="group__zdo.html#ga380de225cf020fe8e9ea521f98571c73" title="Sleep timer wake up indication.">ZDO_WakeUpInd()</a>.</p>
<p>An end device's parent also uses <a class="el" href="cs_defaults_8h.html#af9a5ae0ebfa0d1b3edb25e8acb8738fc" title="End device sleep period given in milliseconds.">CS_END_DEVICE_SLEEP_PERIOD</a> to determine whether it should keep or drop a message addressed to the end device and to decide that the end device is lost if it does not send a poll request for a sufficiently long time. Upon receiving the frame for an end device child its parent saves the message if the <a class="el" href="cs_defaults_8h.html#a67955e6ce37ae632e7248b425cca5e71" title="Enables or disables the power failure feature.">CS_MAC_TRANSACTION_TIME</a> is greater than the estimated time remaining till the next poll request is received from the child. The time of receiving the next poll request is estimated by adding <a class="el" href="cs_defaults_8h.html#af9a5ae0ebfa0d1b3edb25e8acb8738fc" title="End device sleep period given in milliseconds.">CS_END_DEVICE_SLEEP_PERIOD</a> to the moment of receiving the last poll request.</p>
<p>An end device sends poll requests with a period specified in the <a class="el" href="cs_defaults_8h.html#a2ad3c01aef62e31bdd6fe297c52b7dc1" title="A period in ms of polling a parent for data by an end device.">CS_INDIRECT_POLL_RATE</a> parameter, which is also used to calculate the default value for <a class="el" href="cs_defaults_8h.html#a67955e6ce37ae632e7248b425cca5e71" title="Enables or disables the power failure feature.">CS_MAC_TRANSACTION_TIME</a>. See <a href="cs_defaults_8h.html">CS parameters defaults</a> for details.</p>
<p>Note that all time periods are measured in milliseconds.</p>
 <span class="to_top"><a href="#">Back to top</a></span>  <h2><a class="anchor" id="cs_fragment"></a>
Configuring fragmentation</h2>
<p>The fragmentation feature allows to send larger amounts of data than it fits into a single frame, delegating all implementation details to the stack components. However, the maximum length of data that can be sent with one APS request is limited by the choice of certain CS parameters which are described in the list below:</p>
<ul>
<li><a class="el" href="cs_defaults_8h.html#ad79c6b4b58baf08f4320c6ba4dc6664b" title="The maximum number of blocks the asdu can be split into.">CS_APS_MAX_BLOCKS_AMOUNT</a> <br/>
 Specifies the maximum amount of blocks to which request payload can be split.</li>
</ul>
<ul>
<li><a class="el" href="cs_defaults_8h.html#ae9971222d320331827ff6eb9c9633f5c" title="The block size that is used for fragments in fragmented transmission/reception.">CS_APS_BLOCK_SIZE</a> <br/>
 Specifies the size of a block. If the value is 0, then the maximum possible size is used.</li>
</ul>
<ul>
<li><a class="el" href="cs_defaults_8h.html#a5699e12566d7ec5227b32868ad718436" title="Maximum transmission window size (in blocks)">CS_APS_MAX_TRANSMISSION_WINDOW_SIZE</a> <br/>
 The number of frames sent by the stack at once before waiting for acknowledgement. Once the delevery of these frames is acknowledged the next portion of frames is sent.</li>
</ul>
 <span class="to_top"><a href="#">Back to top</a></span>  <h2><a class="anchor" id="cs_tables"></a>
Understanding table sizes</h2>
<p>The stack keeps a set of buffer tables for various purposes. Configuration Server provides a parameter for the size of each table. Since the table are initialized statically these parameters are used to determine an amount of memory that has to be allocated during the compilation and therefore they are not configurable at run time. The tables of particular interest for the application include</p>
<ul>
<li><a class="el" href="cs_defaults_8h.html#ac177d516f6be1bacc13cdd5b87690e41" title="The size of the neighbor table.">CS_NEIB_TABLE_SIZE</a> <br/>
 Stores information about directly accessible devices from the same network.</li>
</ul>
<ul>
<li><a class="el" href="cs_defaults_8h.html#a2ab30b60c24b985b1f136557356db835" title="The maximum number of records in the NWK route table.">CS_ROUTE_TABLE_SIZE</a> <br/>
 Stores next-hop addresses for routes towards certain remote nodes if such routes have already been established by route dicovery. If the stack fails to find a route in this table it launches route discovery procedure employing the route discovery table.</li>
</ul>
<ul>
<li><a class="el" href="cs_defaults_8h.html#a618dd729b44fb2d986ffe94f3a244674" title="The maximum number of records in the NWK route discovery table.">CS_ROUTE_DISCOVERY_TABLE_SIZE</a> <br/>
 Is used by route discovery procedures if the route towards a remote node, which should be reached by a data frame, has not yet found. If the route discovery will be performed frequently, for example, if the routing table size is small, consider whether the size of the route discovery table is enough.</li>
</ul>
<ul>
<li><a class="el" href="cs_defaults_8h.html#a1d68ea073247972683e40fe0b1d7898a" title="The maximum number of records in the binding table.">CS_APS_BINDING_TABLE_SIZE</a> <br/>
 Stores entries for binding links with remote nodes. Each entry contains source extended address and endpoint and destination extended address and endpoint.</li>
</ul>
<ul>
<li><a class="el" href="cs_defaults_8h.html#a139c14e0fdbd943f76634f03dbcf04ca" title="The maximum number of records in the NWK address map table.">CS_ADDRESS_MAP_TABLE_SIZE</a> <br/>
 Contains pairs of corresponding short and extended addresses found out during network operation or by device discovery requests.</li>
</ul>
<ul>
<li><a class="el" href="cs_defaults_8h.html#a114e13f815606128dd2bdf761143a33c" title="The size of of the group table.">CS_GROUP_TABLE_SIZE</a> <br/>
 Stores pairs of a group address and an endpoint. Each group address identifies a group to which the node is subscribed, an endpoint being the destination for data frames addressed to the groups.</li>
</ul>
<p>The application developers should consider properly the sizes for the buffers for it can help reduce the amount of Flash memory consumed by the application.</p>
 <span class="to_top"><a href="#">Back to top</a></span>  <h2><a class="anchor" id="cs_sec_keys"></a>
Security keys</h2>
<p>BitCloud makes use of three types of security keys: network key, link key, and master key. A network key is used for all security modes. Link keys are used in standard link security. Master keys are only valid for high security mode, which is not supported by publicly available BitCloud packages.</p>
<p>All network keys take 16-byte values. A typical way to set up a value in code in to use an array of <code>uint8_t</code>:</p>
<div class="fragment"><pre class="fragment">uint8_t[] securityKey = {0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa};
</pre></div><p>When the <a class="el" href="cs_defaults_8h.html#adf4737f2e4cd911b116993bff74ba74b" title="Default value of the network key.">CS_NETWORK_KEY</a> parameter is specified in <code>configuration.h</code>, the same array notation should be used to point out a value, for example:</p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#define CS_NETWORK_KEY   {0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa}</span>
</pre></div> </div></div>
<hr style="border-top:1px solid #C4CFE5; margin-top:20px"/>
</body>
</html>
