<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>PIC32CX-BZ Zigbee API Reference: Using the ZDO component</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PIC32CX-BZ Zigbee API Reference</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">Using the ZDO component </div>  </div>
</div>
<div class="contents">
<div class="textblock"><p>The ZigBee Device Objects (ZDO) component of the BitCloud stack provides an interface between the application framework, that is a collection of application objects, the device profile, and the <a href="APS.html" class="el">APS</a> layer. ZDO offers several asynchronous requests for performing basic networking operations, such as network formation and join, and a set of functions that help obtain network information from internal stack structures. A considerable part of network related functionality is maintained by ZigBee Device Profile (ZDP) requests. The sections below describe the most common tasks performed with the use of ZDO component.</p>
<p><span class="table_of_contents">References</span> </p>
<ul>
<li><a class="el" href="group__zdo.html">ZDO functions</a> <br/>
 </li>
<li><a class="el" href="zdo_common_8h.html#afceb1ef32c21b6fa29f4dc0f57c48075">ZDO status codes </a> </li>
<li><a class="el" href="zdo_common_8h.html#ZdpClustersList">The list of ZDP requests</a></li>
</ul>
 
<hr style="border-top:1px solid #E0E0FF; margin-top:10px"/>

<span class="table_of_contents">Contents</span>
<ul class="table_of_contents">
  <li>
    <a href="#start_network">Network start</a>
    <ul>
      <li><a href="#join_control">Configuring network start</a></li>
    </ul>
  </li>
  <li><a href="#network_notf">Handling network notifications</a></li>
  <li>
    <a href="#zdp_requests">Sending ZDP requests</a>
    <ul>
      <li><a href="#zdp_device_discovery">Device Discovery requests</a></li>
      <li><a href="#zdp_service_discovery">Service discovery requests</a></li>
      <li><a href="#zdp_leave_network">Leaving the network</a></li>
    </ul>
</ul>
<p></p>
 <span class="to_top"><a href="#">Back to top</a></span>  <h2><a class="anchor" id="start_network"></a>
Network start</h2>
<p>Starting network on a certain device means forming a new network if the device is the coordinator or discovering and joining to an existent network if the device is a router or an end device. In both cases the user should call the <a class="el" href="group__zdo.html#ga5c2330058e9c40c5c771964b0f606c58" title="Performs network formation for coordinator and network join for router or end device.">ZDO_StartNetworkReq()</a> function. The function takes a pointer to an instance of <a class="el" href="struct_z_d_o___start_network_req__t.html" title="Describes the parameters of the ZDO_StartNetworkReq() function.">ZDO_StartNetworkReq_t</a> type as an argument. The only field to be specified in the request parameters is a pointer to the confirmation callback given in the <code>ZDO_StartNetworkConf</code> field. Upon request competion the APS layer fills the <code>confirm</code> field with the execution status and information about the network entered by the device. A pointer to this field is received as the argument of the callback. The following code sample demostrates how to perform a network start.</p>
<div class="fragment"><pre class="fragment"><span class="comment">//The parameters for the network start request</span>
<a class="code" href="struct_z_d_o___start_network_req__t.html" title="Describes the parameters of the ZDO_StartNetworkReq() function.">ZDO_StartNetworkReq_t</a> networkParams;

<span class="comment">//the definition of the callback for the network start request</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> ZDO_StartNetworkConf(<a class="code" href="struct_z_d_o___start_network_conf__t.html" title="Describes the parameters of the ZDO_StartNetworkConf() function.">ZDO_StartNetworkConf_t</a> *confirmInfo)
{
    <span class="comment">//code goes here</span>
}
...
<span class="comment">//configure the request parameters</span>
networkParams.<a class="code" href="struct_z_d_o___start_network_req__t.html#a3ddff2894276f62e2fbba7a02d566f9c">ZDO_StartNetworkConf</a> = ZDO_StartNetworkConf;
<span class="comment">//send the request</span>
<a class="code" href="group__zdo.html#ga5c2330058e9c40c5c771964b0f606c58" title="Performs network formation for coordinator and network join for router or end device.">ZDO_StartNetworkReq</a>(&amp;networkParams);
</pre></div><p>As for the most of requests in BitCloud, the <code>status</code> field of confirmation parameters reports whether the request has been executed successully. The <a class="el" href="zdo_common_8h.html#afceb1ef32c21b6fa29f4dc0f57c48075a485e7e1226f64058373d133748aae368" title="The primitive has finished successfully.">ZDO_SUCCESS_STATUS</a> value indicates that the device has successfully formed or joined the network. In this case network parameters, the short address assigned to the device and the parent address are received as well (see documentation of <a class="el" href="struct_z_d_o___start_network_conf__t.html" title="Describes the parameters of the ZDO_StartNetworkConf() function.">ZDO_StartNetworkConf_t</a>).</p>
<h3><a class="anchor" id="join_control"></a>
Configuring network start</h3>
<p>The stack provides a user with means of further control of a network start. The way the network start goes depends on the ConfigServer parameters with the ID <code>CS_JOIN_CONTROL_ID</code>. The application can fill a structure of <a class="el" href="nwk_common_8h.html#af6e9961a3009f9b9cf365e6574468ff4">NWK_JoinControl_t</a> type and set it a the value of the parameter, using the <a class="el" href="group__cs__functions.html#ga3106f18b9723751a9a5fa9deefa9d906" title="Sets a value of a certain Configuration Server parameter specified by its ID.">CS_WriteParameter()</a> value, at any tiem before network start.</p>
<p>The structure includes the <code>method</code> field, which sets the type of network start. Possible values are given in the <a class="el" href="nwk_common_8h.html#a3025bcd95b4fb2df140efd523b920e8b">NWK_JoinMethod_t</a> enumeration. The default value is <a class="el" href="nwk_common_8h.html#af390cf0e5e1cb1a280022d40fd3ef603a00a1cc28c8c7f401218a75032957a4cb">NWK_JOIN_BY_DEFAULT</a>, which makes the stack select a network start type on the basis of ConfigServer parameters. Basically, if device's type is the coordinator, a new network is formed, and otherwise if the extended PANID of the network (<a class="el" href="cs_defaults_8h.html#ad913e01b52dd44a469260af694c6fd84" title="Extended PAN ID of the network to which the device should join.">CS_EXT_PANID</a>) is unknown the <em>association</em> procedure is used, and if the extended PANID is already known the <em>rejoining</em> procedure is applied. A particular method for the network start is selecting by assigning a different value to the <code>method</code> field. The application can also set any appropriate value, though is shall ensure that all parameters required by the method are set or, otherwise, network start will fail.</p>
<p>Other fields, all of boolean type, of the <a class="el" href="nwk_common_8h.html#af6e9961a3009f9b9cf365e6574468ff4">NWK_JoinControl_t</a> structure are (the application can set these fields as it seems appropriate regardless of the <code>method</code> field's value):</p>
<ul>
<li><code>secured</code> - determines if frames exchanged during network start are encrypted with the network key. The network key should be set in the <a class="el" href="cs_defaults_8h.html#adf4737f2e4cd911b116993bff74ba74b" title="Default value of the network key.">CS_NETWORK_KEY</a> parameter. </li>
<li><code>discoverNetworks</code> - causes the stack to scan for networks during network start (if set to <code>true</code>) or not. During scanning, the neighbor table is filled with entries describing discovered devices. So if this field is set to <code>false</code> the application can fill neighbor table by itself. </li>
<li><code>annce</code> - determines if a device announcement frame will be sent after network start, notifying other devices that a new node has entered the network. The application on a node can track device announcement frames sent by its child nodes if it subscribes to the <a class="el" href="sys_events_8h.html#a90634b33e48478a79c8f07d7aafa1fc2a48a51d6ab6bc5c4004b036ed1b8de060">BC_EVENT_DEVICE_ANNCE</a> event, using the <a class="el" href="group__sys.html#gad3b5e21c529ba6292086924bab7a0019" title="Subscribe a receiver to an event. The same receiver may be subscribed to multiple events by calling t...">SYS_SubscribeToEvent()</a> function.</li>
</ul>
<p>In the following code example the node is configured to join the network via rejoin but without sending a device announcement frame on successful rejoin: </p>
<div class="fragment"><pre class="fragment"><a class="code" href="struct___n_w_k___join_control__t.html">NWK_JoinControl_t</a> joinControl = {
  .<a class="code" href="struct___n_w_k___join_control__t.html#ab7b0b1bdc0a4a318bf8962cae8d2e423">method</a> = <a class="code" href="nwk_common_8h.html#af390cf0e5e1cb1a280022d40fd3ef603ab920572fc8c94cfa77fa1b279a27d01b">NWK_JOIN_VIA_REJOIN</a>,  <span class="comment">//CS_EXT_PANID must be set</span>
  .secured = <span class="keyword">true</span>,
  .discoverNetworks = <span class="keyword">true</span>,
  .annce = <span class="keyword">false</span>                  <span class="comment">//Device announcement won&#39;t be sent after network join</span>
};
<a class="code" href="group__cs__functions.html#ga3106f18b9723751a9a5fa9deefa9d906" title="Sets a value of a certain Configuration Server parameter specified by its ID.">CS_WriteParameter</a>(CS_JOIN_CONTROL_ID, &amp;joinControl); <span class="comment">//Set the parameter in ConfigServer</span>
</pre></div> <span class="to_top"><a href="#">Back to top</a></span>  <h2><a class="anchor" id="network_notf"></a>
Handling network notifications</h2>
<p>Each application must implement the <a class="el" href="group__zdo.html#ga56a1c80b09aea02707718c402ef7b99a" title="Indicates network parameters update.">ZDO_MgmtNwkUpdateNotf(ZDO_MgmtNwkUpdateNotf_t * nwkParams)</a> function. The function is called by the stack when certain network events occur. The type of the event is observed with the <code>nwkParams-&gt;status</code> field. The application can choose to ignore or to process any of the events. Possible event types are given in the following list:</p>
<ul>
<li><a class="el" href="zdo_common_8h.html#afceb1ef32c21b6fa29f4dc0f57c48075affc12c69e3ce238fadaf8293a1044acb" title="Device has joined/rejoined a network and data can be transmitted.">ZDO_NETWORK_STARTED_STATUS</a> <br/>
 Received when the stack performs network start by itself, not initiated on the application level, e.g. when the node automatically rejoined to the network after it had lost connection to the parent.</li>
</ul>
<ul>
<li><a class="el" href="zdo_common_8h.html#afceb1ef32c21b6fa29f4dc0f57c48075a345aa4b99b315471e20a66a86f4d8905" title="Device has lost connection with a parent and the stack tries rejoin by itself. In this case transmiss...">ZDO_NETWORK_LOST_STATUS</a> <br/>
 Indicates parent loss. After issuing this notification, the stack automatically attempts to rejoin the network. This status can be received only on end devices.</li>
</ul>
<ul>
<li><a class="el" href="zdo_common_8h.html#afceb1ef32c21b6fa29f4dc0f57c48075ac637063b33cd46224ff6d282a538394a" title="Device has left a network. If autonetwork option is on, the stack will rejoin a network. Otherwise, an application should rejoin.">ZDO_NETWORK_LEFT_STATUS</a> <br/>
 Is received either when the node loses its parent and fails to rejoin the network or when the node leaves the network by itself in response to a ZDP command.</li>
</ul>
<ul>
<li><a class="el" href="zdo_common_8h.html#afceb1ef32c21b6fa29f4dc0f57c48075a3e23228d327e88b27aae66cbd94d7d42" title="Network parameters have been updated (channel, PanId, shortAddr...)">ZDO_NWK_UPDATE_STATUS</a> <br/>
 Indicates that one or more of network parameters have been changed. Parameters include PANID, channel mask, and node’s short address.</li>
</ul>
<ul>
<li><a class="el" href="zdo_common_8h.html#afceb1ef32c21b6fa29f4dc0f57c48075ac8fe4bb8cbb6acbd9d96944b02a032d5" title="New device has joined a network as a child of this device.">ZDO_CHILD_JOINED_STATUS</a> <br/>
 Indicates that a new child has successfully joined to the current node. This status is not valid for end devices. The notification is raised when the current node, from its side, finishes all procedures as the parent of the new node: for example, if security is applied in the network, when the node sends a transport key command. This does not necessarily mean that the child device will successfully decrypt the transport key command and complete network join. This is only verified by the device announcement frame. The parent node can track its reception by subscribing to the <a class="el" href="sys_events_8h.html#a90634b33e48478a79c8f07d7aafa1fc2a48a51d6ab6bc5c4004b036ed1b8de060">BC_EVENT_DEVICE_ANNCE</a> event.</li>
</ul>
<ul>
<li><a class="el" href="zdo_common_8h.html#afceb1ef32c21b6fa29f4dc0f57c48075a6cc6e8ea6285c4d441b21658e73004c8" title="Child has been removed from children list.">ZDO_CHILD_REMOVED_STATUS</a> <br/>
 Indicates that a child has left the network.</li>
</ul>
<ul>
<li><a class="el" href="zdo_common_8h.html#afceb1ef32c21b6fa29f4dc0f57c48075a0881cb5c784fc8cfa76766f2378ca61c" title="On the device with static addressing the conflict of network addresses has been detected.">ZDO_STATIC_ADDRESS_CONFLICT_STATUS</a> <br/>
 Indicates that a short address set statically has leaded to the address conflict. The event is raised on the node that discovered the conflict. The application is responsible for resolving the conflict, typically by choosing a different short address and updating its value on the node via a ZDP request.</li>
</ul>
<ul>
<li><a class="el" href="zdo_common_8h.html#afceb1ef32c21b6fa29f4dc0f57c48075a47ec595158abf8aa5d83098b28bac510" title="Trust center could not find key pair descriptor to authenticate device.">ZDO_NO_KEY_PAIR_DESCRIPTOR_STATUS</a> <br/>
 The status is valid only if a security mode with link keys is used. The event is raised on the trust center node and indicates that the link key for the device that attempts to join the network has not been found. The application can save the extended address of the potential child to extract the link key for it from an external source of information, so that the child can be authenticated when it makes the next attempt to join the network.</li>
</ul>
<p>The definition of the <a class="el" href="group__zdo.html#ga56a1c80b09aea02707718c402ef7b99a" title="Indicates network parameters update.">ZDO_MgmtNwkUpdateNotf()</a> function in the application code might look like the following:</p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">void</span> <a class="code" href="group__zdo.html#ga56a1c80b09aea02707718c402ef7b99a" title="Indicates network parameters update.">ZDO_MgmtNwkUpdateNotf</a>(<a class="code" href="struct_z_d_o___mgmt_nwk_update_notf__t.html" title="The type used to pack information about network updates in an argument of ZDO_MgmtNwkUpdateNotf() fun...">ZDO_MgmtNwkUpdateNotf_t</a> *nwkParams)
{
  <span class="keywordflow">switch</span> (nwkParams-&gt;<a class="code" href="struct_z_d_o___mgmt_nwk_update_notf__t.html#ac5704201494b56692aca8d22bb5c2ae7">status</a>)
  {
    <span class="keywordflow">case</span> <a class="code" href="zdo_common_8h.html#afceb1ef32c21b6fa29f4dc0f57c48075affc12c69e3ce238fadaf8293a1044acb" title="Device has joined/rejoined a network and data can be transmitted.">ZDO_NETWORK_STARTED_STATUS</a>:
      <span class="comment">//More code goes here, e.g. the application may save new</span>
      <span class="comment">//network parameters</span>
      ...
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="zdo_common_8h.html#afceb1ef32c21b6fa29f4dc0f57c48075a47ec595158abf8aa5d83098b28bac510" title="Trust center could not find key pair descriptor to authenticate device.">ZDO_NO_KEY_PAIR_DESCRIPTOR_STATUS</a>:
<span class="preprocessor">#ifdef _LINK_SECURITY_</span>
<span class="preprocessor"></span>      <span class="comment">//The event can occur in high security mode on the trust center only</span>
      <span class="comment">//Extract the extended address of the device attempting to join the network</span>
      <a class="code" href="mac_addr_8h.html#a5b2913b1523fd1ce0a399c4fb047cc8b" title="Extended address type declaration.">ExtAddr_t</a> addr = nwkParams-&gt;<a class="code" href="struct_z_d_o___mgmt_nwk_update_notf__t.html#a0a743938a9a7113a0a17fe159ff32573" title="Information about joined device or failed to authenticate child event.">childInfo</a>.<a class="code" href="struct_child_info__t.html#a0e48382b2abf8f68c44023af1ab0126b" title="Extended address.">extAddr</a>;
      uint8_t   linkKey[16] = ...; <span class="comment">//Find out the link key value and store in this variable</span>
      <a class="code" href="group__aps__security.html#ga4d97ec9bad11b340c8fa114db1d7a92c" title="Sets a link key for the device with a given extended address.">APS_SetLinkKey</a>(&amp;addr, linkKey); <span class="comment">//Set the link key for the given extended address</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      <span class="keywordflow">break</span>;
    <span class="keywordflow">default</span>:
      <span class="keywordflow">break</span>;
  }
}
</pre></div><p> Note the use of the <code>_LINK_SECURITY_</code> define. It marks code parts that will be included if the application is compiled with standard link security mode. If the code in the callback may consume more than 10ms, its execution should be <a href="overview.html#def_task_exec">deferred</a>.</p>
 <span class="to_top"><a href="#">Back to top</a></span>  <h2><a class="anchor" id="zdp_requests"></a>
Sending ZDP requests</h2>
<p>ZigBee Device Profile (ZDP) requests provide a set of functionality for managing the network, discovering devices and services, etc. The <a class="el" href="group__zdo.html#gad2406e206b8fe81a68b44e8f7112f20a" title="Sends a ZDP request.">ZDO_ZdpReq()</a> function issues a ZDP request. A particular action performed by the function is detemined by the <code>reqCluster</code> field in an instance of the <a class="el" href="struct_z_d_o___zdp_req__t.html" title="ZDP request. Describes the parameters of the ZDO_ZdpReq() function.">ZDO_ZdpReq_t</a> type representing request parameters. Additional request parameters are given in the <code>req.reqPayload</code> field, which is actually a union, so that the same memory is used for parameters specific for different request types.</p>
<p>Since the function is executed asynchronously, request parameters' instance shall be defined in a global scope (or file scope - using the static keyword). Note that an instance of request parameters must not be reused until the confirmation callback is called for the current request, because the callback function uses the pointer to response parameters residing in the instance of the request parameters, as an argument.</p>
<p>The following sections provide some examples of issuing ZDP requests of various types. For more examples explore the code of sample applications provided with the SDK.</p>
<h3><a class="anchor" id="zdp_device_discovery"></a>
Device Discovery requests</h3>
<p>Two typical tasks in ZigBee application development are obtaining the extended address of a remote device corresponding to a given short address and the reverse task of discovering the short address of the device with a given extended address. These tasks are accomplished with a help of ZDP requests of <a class="el" href="zdo_common_8h.html#aaf8fd5f0e57d456151c951e0f3715fc4a5f82e8ee6326f3c9011130028c2150b6" title="Request for the 64-bit IEEE address of a remote device based on its known 16-bit address.">IEEE_ADDR_CLID</a> and <a class="el" href="zdo_common_8h.html#aaf8fd5f0e57d456151c951e0f3715fc4ac74a17ef13dadfbed128cd8a75131bc6" title="Request for the 16-bit address of a remote device based on its known IEEE address.">NWK_ADDR_CLID</a> types, respectively. For example, to obtain the extended address the following code may be used:</p>
<div class="fragment"><pre class="fragment"><a class="code" href="struct_z_d_o___ieee_addr_req__t.html" title="This request is generated from a Local Device wishing to inquire as to the 64-bit IEEE address of the...">ZDO_IeeeAddrReq_t</a> *ieeeAddrReq = &amp;zdpReq.req.reqPayload.ieeeAddrReq;
zdpReq.ZDO_ZdpResp = zdpIeeeAddrResp; <span class="comment">//confirmation callback function</span>
zdpReq.reqCluster = <a class="code" href="zdo_common_8h.html#aaf8fd5f0e57d456151c951e0f3715fc4a5f82e8ee6326f3c9011130028c2150b6" title="Request for the 64-bit IEEE address of a remote device based on its known 16-bit address.">IEEE_ADDR_CLID</a>; <span class="comment">//type of request</span>
ieeeAddrReq-&gt;<a class="code" href="struct_z_d_o___ieee_addr_req__t.html#a9177d2c6ed45432525edf569e1cc0b50">nwkAddrOfInterest</a> = nwkAddr; <span class="comment">//the destination short address</span>
ieeeAddrReq-&gt;<a class="code" href="struct_z_d_o___ieee_addr_req__t.html#a5f9793056ef2a08deaaa2353498f1728">reqType</a> = <a class="code" href="zdo_common_8h.html#a39fca1837c5ce7715cbf571669660c13a9cbf989e0a7212299f01cf04d4471526" title="Only the address of the target device is requested.">SINGLE_RESPONSE_REQUESTTYPE</a>; <span class="comment">//indicate that response is expected from</span>
                                                    <span class="comment">//one node only - and not from its children</span>
ieeeAddrReq-&gt;<a class="code" href="struct_z_d_o___ieee_addr_req__t.html#ada5a2eda4e78f100e0d66e747bcc23e3">startIndex</a> = 0;
<a class="code" href="group__zdo.html#gad2406e206b8fe81a68b44e8f7112f20a" title="Sends a ZDP request.">ZDO_ZdpReq</a>(&amp;zdpReq); <span class="comment">//send the request</span>
</pre></div><p>Implementation of the callback function for this request might look like the following:</p>
<div class="fragment"><pre class="fragment"><span class="keyword">static</span> <span class="keywordtype">void</span> zdpIeeeAddrResp(<a class="code" href="struct_z_d_o___zdp_resp__t.html" title="ZDP response.">ZDO_ZdpResp_t</a> *resp)
{
  <span class="comment">//Convert the response to the appropriate type</span>
  <a class="code" href="struct_z_d_o___ieee_addr_resp__t.html" title="This command is generated by a Remote Device in response to an IEEE_addr_req command inquiring as to ...">ZDO_IeeeAddrResp_t</a> *ieeeAddrResp = (<a class="code" href="struct_z_d_o___ieee_addr_resp__t.html" title="This command is generated by a Remote Device in response to an IEEE_addr_req command inquiring as to ...">ZDO_IeeeAddrResp_t</a> *) &amp;resp-&gt;<a class="code" href="struct_z_d_o___zdp_resp__t.html#af0b9aa9a7b5f7d6b968680a0ebf39198" title="Response frame.">respPayload</a>.<a class="code" href="struct_z_d_o___zdp_resp_frame__t.html#a6353b42bd3e16f5ff6bedea7e357b223" title="IEEE address response.">ieeeAddrResp</a>;
  <span class="comment">//Check whether the operation is a success</span>
  if (<a class="code" href="zdo_common_8h.html#afceb1ef32c21b6fa29f4dc0f57c48075a485e7e1226f64058373d133748aae368" title="The primitive has finished successfully.">ZDO_SUCCESS_STATUS</a> == resp-&gt;<a class="code" href="struct_z_d_o___zdp_resp__t.html#af0b9aa9a7b5f7d6b968680a0ebf39198" title="Response frame.">respPayload</a>.<a class="code" href="struct_z_d_o___zdp_resp_frame__t.html#a1633715425138fdbfe722a6d96aa16d7" title="Result of a ZDP request. Is interpreted as ZDO_Status_t. See details.">status</a>)
  {
    <span class="comment">//The desired extended address is contained in ieeeAddrResp-&gt;ieeeAddrRemote field</span>
    ... <span class="comment">//Perform actions that required obtaining the address</span>
    <span class="comment">//Post a task to notify the stack that APL_TaskHandler() should be executed</span>
    <a class="code" href="group__sys.html#ga19cb63c28d94c2870db54ef53ba2ccd3" title="Posts a task to the task manager, which is later processed by the task handler of the corresponding s...">SYS_PostTask</a>(<a class="code" href="sys_task_manager_8h.html#a32d97e8a721502f064d710c72ff37a49a55843692403cb558c08beea668d7622f" title="Task ID of the application.">APL_TASK_ID</a>);
  }
  <span class="keywordflow">else</span>
  {
    <span class="comment">//Execute required logic, e.g. perform IEEE request again</span>
  }
}
</pre></div><p>Note that the response payload should be converted to the type conforming to the type of the issued request. For that, select appropriate field from the union inside the <code>respPayload</code> field.</p>
<h3><a class="anchor" id="zdp_service_discovery"></a>
Service Discovery requests</h3>
<p>Service Discovery stands for procedures of collecting information about network devices and functionality (clusters) they support. Using Service Discovery, the application on the current node is able to find out short addresses of devices that support certain input or output clusters and accomplish some other similar tasks.</p>
<p>An essential ZDP request implementing Service Discovery that is frequenty needed in applications is of type <a class="el" href="zdo_common_8h.html#aaf8fd5f0e57d456151c951e0f3715fc4a1d325fb1f092187e9d0754cbd6eeb930" title="Request for remote devices supporting a specific simple descriptor match criterion.">MATCH_DESCRIPTOR_CLID</a>. It launches a search for devices that have registered endpoints supporting the specified clusters. The request can be sent either to a specific node identified with the short address or to a broadcast address. The application can specify a list of input and a list of output clusters, although it is rarely useful to point out more than one cluster, because a destination node responds with a list of all its endpoints that support at least one input or output cluster specified in the request. The following code sends a match descriptor request:</p>
<div class="fragment"><pre class="fragment"><span class="comment">//define global variables</span>
<span class="keyword">static</span> <a class="code" href="struct_z_d_o___zdp_req__t.html" title="ZDP request. Describes the parameters of the ZDO_ZdpReq() function.">ZDO_ZdpReq_t</a> zdpReq;
...
ZDO_MatchDescReq_t *matchDescReq = &amp;zdpReq.<a class="code" href="struct_z_d_o___zdp_req__t.html#ae667a434f5842f8635cde7a40b206106" title="ZDP request parameters.">req</a>.<a class="code" href="struct_z_d_o___zdp_frame__t.html#a075ead99c2f90df6ceb77bfc17a0ad85">reqPayload</a>.<a class="code" href="struct_z_d_o___zdp_req_frame__t.html#a3a3e1e93c4d05733687e5d574ae7b9eb" title="Match descriptor request.">matchDescReq</a>;

zdpReq.<a class="code" href="struct_z_d_o___zdp_req__t.html#a68e6b8710a3562414b23eb814cf826b5" title="Response callback. Must not be set to NULL.">ZDO_ZdpResp</a> = zdpMatchDescResp; <span class="comment">//confirmation callback</span>
zdpReq.<a class="code" href="struct_z_d_o___zdp_req__t.html#a87b56c03c4ef53e571fe1f0bab48f198" title="Request&#39;s type; takes values from the enumeration.">reqCluster</a> = <a class="code" href="zdo_common_8h.html#aaf8fd5f0e57d456151c951e0f3715fc4a1d325fb1f092187e9d0754cbd6eeb930" title="Request for remote devices supporting a specific simple descriptor match criterion.">MATCH_DESCRIPTOR_CLID</a>; <span class="comment">//set request type</span>

matchDescReq-&gt;nwkAddrOfInterest = CPU_TO_LE16(BROADCAST_SHORT_ADDRESS);
matchDescReq-&gt;profileId = CPU_TO_LE16(APP_PROFILE); <span class="comment">//set profile ID</span>
matchDescReq-&gt;numInClusters = 1; <span class="comment">//number of clusters</span>
matchDescReq-&gt;inClusterList[0] = APP_CLUSTER; <span class="comment">//set cluster ID</span>

<a class="code" href="group__zdo.html#gad2406e206b8fe81a68b44e8f7112f20a" title="Sends a ZDP request.">ZDO_ZdpReq</a>(&amp;zdpReq); <span class="comment">//send the request</span>
</pre></div><p>Each reply from a discovered device received by the request's originator causes the confirmation callback to be called. As soon as the request is issued the stack starts a timer and waits for replies during a period of time specified in the <a class="el" href="cs_defaults_8h.html#a6963cffa6bdf0472b1f648bd657b2869" title="ZDP response awaiting timeout in milliseconds. To use automatically calculated value, set to 0.">CS_ZDP_RESPONSE_TIMEOUT</a> parameter. When the timer elapses, the stack fires the callback with the <a class="el" href="zdo_common_8h.html#afceb1ef32c21b6fa29f4dc0f57c48075a8b8607ff5b05ae92768e8ac830fd2b7a">ZDO_CMD_COMPLETED_STATUS</a> status code. The default <a class="el" href="cs_defaults_8h.html#a6963cffa6bdf0472b1f648bd657b2869" title="ZDP response awaiting timeout in milliseconds. To use automatically calculated value, set to 0.">CS_ZDP_RESPONSE_TIMEOUT</a>'s value is calculated by the stack in such a way that the devices sleeping at the moment the request is sent are not expected to have time to awake and answer the request. So the request will normally reach only active devices.</p>
<p>Each response contains the short address, the number of matching endpoints and the list of matching endpoints. The confirmation callback's implementation can be like this:</p>
<div class="fragment"><pre class="fragment"><span class="comment">//A callback function for the ZDP match descriptor request</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> zdpMatchDescResp(<a class="code" href="struct_z_d_o___zdp_resp__t.html" title="ZDP response.">ZDO_ZdpResp_t</a> *resp)
{
  <a class="code" href="struct_z_d_o___match_desc_resp__t.html">ZDO_MatchDescResp_t</a> *matchResp = &amp;resp-&gt;<a class="code" href="struct_z_d_o___zdp_resp__t.html#af0b9aa9a7b5f7d6b968680a0ebf39198" title="Response frame.">respPayload</a>.<a class="code" href="struct_z_d_o___zdp_resp_frame__t.html#a08e9c4b4f4ce598c722e2058d90b232f" title="Match descriptor response.">matchDescResp</a>;
  <span class="keywordflow">if</span> (<a class="code" href="zdo_common_8h.html#afceb1ef32c21b6fa29f4dc0f57c48075a8b8607ff5b05ae92768e8ac830fd2b7a">ZDO_CMD_COMPLETED_STATUS</a> == resp-&gt;<a class="code" href="struct_z_d_o___zdp_resp__t.html#af0b9aa9a7b5f7d6b968680a0ebf39198" title="Response frame.">respPayload</a>.<a class="code" href="struct_z_d_o___zdp_resp_frame__t.html#a1633715425138fdbfe722a6d96aa16d7" title="Result of a ZDP request. Is interpreted as ZDO_Status_t. See details.">status</a>) {
    <span class="comment">//timeout has expired; this is the last time the callback is called</span>
    <span class="comment">//for the current request</span>
  }
  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="zdo_common_8h.html#afceb1ef32c21b6fa29f4dc0f57c48075a485e7e1226f64058373d133748aae368" title="The primitive has finished successfully.">ZDO_SUCCESS_STATUS</a> == resp-&gt;<a class="code" href="struct_z_d_o___zdp_resp__t.html#af0b9aa9a7b5f7d6b968680a0ebf39198" title="Response frame.">respPayload</a>.<a class="code" href="struct_z_d_o___zdp_resp_frame__t.html#a1633715425138fdbfe722a6d96aa16d7" title="Result of a ZDP request. Is interpreted as ZDO_Status_t. See details.">status</a>) {
    <span class="comment">//process another response from the network: for example, the application</span>
      <span class="comment">//can immediately send a ZDP request to obtain the extended address of the device</span>
    doIeeeAddrReq();
  }
  <span class="keywordflow">else</span> {
    <span class="comment">//process failure statuses</span>
  }
}
</pre></div><h3><a class="anchor" id="zdp_leave_network"></a>
Leaving the network</h3>
<p>To force a device to leave the network issue a ZDP request of the <a class="el" href="zdo_common_8h.html#aaf8fd5f0e57d456151c951e0f3715fc4ac2b1e0911f2526595f35d8af301504c8" title="Request generated from a Local Device requesting that a Remote Device leave the network or to request...">MGMT_LEAVE_CLID</a> type. The request can also be used to force a remote node to leave the network. A node that has left the network cannot be reached by remote data requests and can not sent data to remote nodes from the application layer. To return to the network the node should issue network start request. To ensure that the same network will be chosen during network scan procedures, the PANID value of the previous network shall be saved before network leave and indicated as predefined.</p>
<p>The folowing examples illustrates parameters configuration for the <a class="el" href="zdo_common_8h.html#aaf8fd5f0e57d456151c951e0f3715fc4ac2b1e0911f2526595f35d8af301504c8" title="Request generated from a Local Device requesting that a Remote Device leave the network or to request...">MGMT_LEAVE_CLID</a> request which will force the current node to leave the network:</p>
<div class="fragment"><pre class="fragment"><span class="keyword">static</span> <a class="code" href="struct_z_d_o___zdp_req__t.html" title="ZDP request. Describes the parameters of the ZDO_ZdpReq() function.">ZDO_ZdpReq_t</a> zdpLeaveReq; <span class="comment">//globally defined variable</span>
...
<span class="comment">//set corresponding cluster ID </span>
zdpLeaveReq.<a class="code" href="struct_z_d_o___zdp_req__t.html#a87b56c03c4ef53e571fe1f0bab48f198" title="Request&#39;s type; takes values from the enumeration.">reqCluster</a> = <a class="code" href="zdo_common_8h.html#aaf8fd5f0e57d456151c951e0f3715fc4ac2b1e0911f2526595f35d8af301504c8" title="Request generated from a Local Device requesting that a Remote Device leave the network or to request...">MGMT_LEAVE_CLID</a>; 
zdpLeaveReq.<a class="code" href="struct_z_d_o___zdp_req__t.html#a0727b46b3cd57f07a25adfd6fe393b09" title="Destination address mode, either short (network) address, group or extended address mode...">dstAddrMode</a> = EXT_ADDR_MODE;
zdpLeaveReq.dstExtAddr = 0; <span class="comment">// for own node address shall be 0</span>
zdpLeaveReq.<a class="code" href="struct_z_d_o___zdp_req__t.html#a68e6b8710a3562414b23eb814cf826b5" title="Response callback. Must not be set to NULL.">ZDO_ZdpResp</a> = ZDO_ZdpLeaveResp; <span class="comment">// callback</span>

<span class="comment">//for own node address shall be 0 </span>
zdpLeaveReq.<a class="code" href="struct_z_d_o___zdp_req__t.html#ae667a434f5842f8635cde7a40b206106" title="ZDP request parameters.">req</a>.<a class="code" href="struct_z_d_o___zdp_frame__t.html#a075ead99c2f90df6ceb77bfc17a0ad85">reqPayload</a>.<a class="code" href="struct_z_d_o___zdp_req_frame__t.html#a02ff143bb3284413c328d09aae866721" title="Leave request.">mgmtLeaveReq</a>.<a class="code" href="struct_z_d_o___mgmt_leave_req__t.html#ad25903c9d28fc7b5631ce0c6d3e5546f" title="Reserved; can not be changed by user.">deviceAddr</a> = 0;
<span class="comment">//specify whether to force children leave or not </span>
zdpLeaveReq.<a class="code" href="struct_z_d_o___zdp_req__t.html#ae667a434f5842f8635cde7a40b206106" title="ZDP request parameters.">req</a>.<a class="code" href="struct_z_d_o___zdp_frame__t.html#a075ead99c2f90df6ceb77bfc17a0ad85">reqPayload</a>.<a class="code" href="struct_z_d_o___zdp_req_frame__t.html#a02ff143bb3284413c328d09aae866721" title="Leave request.">mgmtLeaveReq</a>.removeChildren = 0;

<span class="comment">//specify whether to perform rejoin procedure after network leave </span>
zdpLeaveReq.<a class="code" href="struct_z_d_o___zdp_req__t.html#ae667a434f5842f8635cde7a40b206106" title="ZDP request parameters.">req</a>.<a class="code" href="struct_z_d_o___zdp_frame__t.html#a075ead99c2f90df6ceb77bfc17a0ad85">reqPayload</a>.<a class="code" href="struct_z_d_o___zdp_req_frame__t.html#a02ff143bb3284413c328d09aae866721" title="Leave request.">mgmtLeaveReq</a>.<a class="code" href="struct_z_d_o___mgmt_leave_req__t.html#aca60393e4ec495a5257bf242371f5bd8">rejoin</a> = 0;
<a class="code" href="group__zdo.html#gad2406e206b8fe81a68b44e8f7112f20a" title="Sends a ZDP request.">ZDO_ZdpReq</a>(&amp;zdpLeaveReq); <span class="comment">// request for network leave</span>
</pre></div><p>The request can also be used for asking a remote node to leave. Moreover, it is possible to force all its direct children to leave. For that, parameters shall be configured in a different way as it is shown below:</p>
<div class="fragment"><pre class="fragment"><span class="keyword">static</span> <a class="code" href="struct_z_d_o___zdp_req__t.html" title="ZDP request. Describes the parameters of the ZDO_ZdpReq() function.">ZDO_ZdpReq_t</a> zdpLeaveReq; <span class="comment">//globally defined variable</span>
...
<span class="comment">//set corresponding cluster ID </span>
zdpLeaveReq.<a class="code" href="struct_z_d_o___zdp_req__t.html#a87b56c03c4ef53e571fe1f0bab48f198" title="Request&#39;s type; takes values from the enumeration.">reqCluster</a> = <a class="code" href="zdo_common_8h.html#aaf8fd5f0e57d456151c951e0f3715fc4ac2b1e0911f2526595f35d8af301504c8" title="Request generated from a Local Device requesting that a Remote Device leave the network or to request...">MGMT_LEAVE_CLID</a>; 
zdpLeaveReq.<a class="code" href="struct_z_d_o___zdp_req__t.html#a0727b46b3cd57f07a25adfd6fe393b09" title="Destination address mode, either short (network) address, group or extended address mode...">dstAddrMode</a> = EXT_ADDR_MODE;
zdpLeaveReq.dstExtAddr = DST_EXT_ADDRESS; <span class="comment">//for own node address shall be 0</span>
zdpLeaveReq.<a class="code" href="struct_z_d_o___zdp_req__t.html#a68e6b8710a3562414b23eb814cf826b5" title="Response callback. Must not be set to NULL.">ZDO_ZdpResp</a> = ZDO_ZdpLeaveResp; <span class="comment">//confirmation callback</span>

<span class="comment">//for own node should be 0 (or equal own address)</span>
zdpLeaveReq.<a class="code" href="struct_z_d_o___zdp_req__t.html#ae667a434f5842f8635cde7a40b206106" title="ZDP request parameters.">req</a>.<a class="code" href="struct_z_d_o___zdp_frame__t.html#a075ead99c2f90df6ceb77bfc17a0ad85">reqPayload</a>.<a class="code" href="struct_z_d_o___zdp_req_frame__t.html#a02ff143bb3284413c328d09aae866721" title="Leave request.">mgmtLeaveReq</a>.<a class="code" href="struct_z_d_o___mgmt_leave_req__t.html#ad25903c9d28fc7b5631ce0c6d3e5546f" title="Reserved; can not be changed by user.">deviceAddr</a> = DST_EXT_ADDRESS;
<span class="comment">//specify whether to force children leave or not </span>
zdpLeaveReq.<a class="code" href="struct_z_d_o___zdp_req__t.html#ae667a434f5842f8635cde7a40b206106" title="ZDP request parameters.">req</a>.<a class="code" href="struct_z_d_o___zdp_frame__t.html#a075ead99c2f90df6ceb77bfc17a0ad85">reqPayload</a>.<a class="code" href="struct_z_d_o___zdp_req_frame__t.html#a02ff143bb3284413c328d09aae866721" title="Leave request.">mgmtLeaveReq</a>.removeChildren = 1;

<span class="comment">//specify whether to perform rejoin procedure after network leave</span>
zdpLeaveReq.<a class="code" href="struct_z_d_o___zdp_req__t.html#ae667a434f5842f8635cde7a40b206106" title="ZDP request parameters.">req</a>.<a class="code" href="struct_z_d_o___zdp_frame__t.html#a075ead99c2f90df6ceb77bfc17a0ad85">reqPayload</a>.<a class="code" href="struct_z_d_o___zdp_req_frame__t.html#a02ff143bb3284413c328d09aae866721" title="Leave request.">mgmtLeaveReq</a>.<a class="code" href="struct_z_d_o___mgmt_leave_req__t.html#aca60393e4ec495a5257bf242371f5bd8">rejoin</a> = 0;
<a class="code" href="group__zdo.html#gad2406e206b8fe81a68b44e8f7112f20a" title="Sends a ZDP request.">ZDO_ZdpReq</a>(&amp;zdpLeaveReq); <span class="comment">// request for network leave</span>
</pre></div><p>If the <code>rejoin</code> field is set to <code>1</code>, then a destination node will attempt to join the network again after the network leave is complete. It may be used to force a device to change its parent or join with a deffirent short address. </p>
</div></div>
<hr style="border-top:1px solid #C4CFE5; margin-top:20px"/>
</body>
</html>
